<html>
<meta charset="UTF-8">
<head>
    <link rel="stylesheet" href="styles.css">
    <title>Загрузка файлов</title>
</head>
<body>
    <div id="mainContainer">
        <div id = uploadFormDiv>
            <p><b>Загрузка файлов на сервер</b></p>
            <form id="uploadForm">
                <input type="file" name="fileToUpload" id="fileInput">
                <button type="submit">Загрузить</button>
            </form>
            <div>
                <progress id="progressBar" value="0" max="100" style="display:none;"></progress>
                <p></p>
                <div id="status"></div>
                <p></p>

                <script>
                    const uploadForm = document.getElementById('uploadForm');
                    const status = document.getElementById('status');
                    const progressBar = document.getElementById('progressBar');

                    uploadForm.onsubmit = async (e) => {
                        e.preventDefault();

                        const fileInput = document.getElementById('fileInput');
                        if (fileInput.files.length === 0) return alert("Выберите файл!");

                        const formData = new FormData();
                        formData.append("fileToUpload", fileInput.files[0]);

                        status.innerText = "Загрузка...";
                        progressBar.style.display = "block";

                        const xhr = new XMLHttpRequest();

                        xhr.upload.onprogress = (event) => {
                            if (event.lengthComputable) {
                                progressBar.value = (event.loaded / event.total) * 100;
                            }
                        };

                        xhr.onload = () => {
                            if (xhr.status === 200) {
                                const generatedFileName = xhr.responseText.replace("OK: ", "").trim();
                                const downloadUrl = `/view?id=${generatedFileName}`;

                                status.innerHTML = `Файл загружен успешно! <br><a href="${downloadUrl}" target="_blank">Скачать файл</a>`;
                                progressBar.value = 100;
                            } else {
                                status.innerText = "Ошибка при загрузке: " + xhr.responseText;
                            }
                        };

                        xhr.open("POST", "/upload");
                        xhr.send(formData);
                    };
                </script>
            </div>
            <form action="/logout">
                <button>Выйти</button>
            </form>
        </div>
    </div>
</body>
</html>
