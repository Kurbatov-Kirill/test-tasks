<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="styles.css">
    <title>Прогноз погоды</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="container">
    <h2 style="text-align: center;">Прогноз на 24 часа</h2>

    <div class="search-box">
        <input type="text" id="cityInput" placeholder="Введите город (напр. London)">
        <button onclick="getWeather()">Найти</button>
    </div>

    <div id="error">Ошибка: Город не найден или сервер недоступен</div>

    <div id="weather-info" class="weather-info">
        <h3 id="cityName">Город</h3>
        <div class="temp-main" id="currentTemp">--°C</div>
    </div>

    <div id="chartWrapper" class="chart-wrapper">
        <canvas id="weatherChart"></canvas>
    </div>
</div>

<script>
    let myChart = null; //

    async function getWeather() {
        const city = document.getElementById('cityInput').value;
        const errorDiv = document.getElementById('error');
        const infoDiv = document.getElementById('weather-info');
        const chartDiv = document.getElementById('chartWrapper');

        if (!city) return;

        if (typeof Chart === 'undefined') {
            alert("Ошибка: Библиотека Chart.js не загружена!");
            return;
        }

        try {
            const response = await fetch(`weather?city=${encodeURIComponent(city)}`);
            if (!response.ok) throw new Error("Server error");

            const data = await response.json();
            document.getElementById('cityName').innerText = data.cityName;
            if (data.city_name) {
                document.getElementById('cityName').innerText = data.city_name;
            } else {
                document.getElementById('cityName').innerText = city.charAt(0).toUpperCase() + city.slice(1);
            }
            console.log("Данные получены:", data);

            document.getElementById('cityName').innerText = city.toUpperCase();
            const tempNow = data.hourly.temperature_2m[0];
            document.getElementById('currentTemp').innerText = Math.round(tempNow) + "°C";

            renderChart(data.hourly.time, data.hourly.temperature_2m);

            errorDiv.style.display = 'none';
            infoDiv.style.display = 'block';
            chartDiv.style.display = 'block';

        } catch (err) {
            console.error("Ошибка в JS:", err);
            errorDiv.style.display = 'block';
            infoDiv.style.display = 'none';
            chartDiv.style.display = 'none';
        }
    }

    function renderChart(labels, temps) {
        const ctx = document.getElementById('weatherChart').getContext('2d');

        if (myChart) {
            myChart.destroy();
        }

        const formattedLabels = labels.map(t => t.substring(11, 16));

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: 'Температура (°C)',
                    data: temps,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: '#f0f0f0' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    }
</script>

</body>
</html>